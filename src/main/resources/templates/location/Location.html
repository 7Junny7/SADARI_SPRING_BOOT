<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<link rel="stylesheet"
   href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
   integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
   crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
   integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
   crossorigin="anonymous"></script>
<script
   src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
   integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
   crossorigin="anonymous"></script>
<script
   src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
   integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
   crossorigin="anonymous"></script>

<meta charset="UTF-8">
<style type="text/css">
h1 {
   text-align: center;
   margin: 3%;
}

table {
   text-align: center;
}
</style>
<title>작성글</title>
</head>
<body th:align="center" style="background-color: #f5f6f7">
	<a class="navbar-brand" href="/home"><img src="./img/logo.png"
		alt="로고" style="width: 200px;"></a>
	<div class="container" th:align="center">
		<div class="row" th:align="center">
			<div class="table-responsive">
				<h1 style="color: #f97d66;">작성글</h1>
				<br>
<form th:action="@{/updateLocation}" method="get">
					<input th:hidden="${loc.boardidx}" name="boardidx" id="boardidx" th:value="${loc.boardidx}">
					<table th:align="center" border="0" th:cellpadding="0"
						th:cellspacing="0" style="width: 611px;">
						<tr>
							<td th:text="식당이름"
								style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">식당이름</td>
							<td th:text="${loc.restaurant}" id="restaurant"></td>
						</tr>
						<tr>
							<td th:text="음식종류"
								style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">음식종류</td>
							<td th:text="${loc.foodType}" id="foodType"><span
								th:hidden="${loc.foodLikeScore}"></span> <span
								th:hidden="${loc.foodLikePerson}"></span></td>
						</tr>
						<tr>
							<td th:text="글제목"
								style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">글제목</td>
							<td th:text="${loc.subject}"></td>
						</tr>
						<tr>
							<td th:text="날짜"
								style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">날짜</td>
							<td th:text="${loc.date}" id="date"></td>
						</tr>
						<tr>
							<td th:text="시간"
								style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">시간</td>
							<td th:text="${loc.time}" id="time"></td>
						</tr>
						<tr>
							<td th:text="작성자"
								style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">시간</td>
							<td th:text="${loc.writer}"></td>
						</tr>
						<tr>
							<td th:text="인원수"
								style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">인원수</td>
							<td><div th:text="${loc.likeup}" th:value="${loc.likeup}" style="display: inline;" ></div> / <div th:text="${loc.wantWho}" th:value="${loc.wantWho}" style="display: inline;"></div></td>
							
							<td>
								<input th:value="${loc.likeup}" th:hidden="${loc.likeup}" id="likeup"/>
	 							<input th:value="${loc.wantWho}" th:hidden="${loc.wantWho}" id="wantWho"/>
 							</td>
						</tr>
						<tr>
                     <td th:text="작성내용"
                        style="background-color: #f97d66; width: 200px; height: 50px; border: 0; color: white; text-align: center;">작성내용</td>
                     <td th:text="${loc.foodComment}"></td>
                  </tr>
                  <tr>
                     <td style="color: #f5f6f7;" colspan="2">.</td>
                  </tr>
                  <tr>
                     <td>
                	<td style="height: 50px;">
                     	<input type="button" onclick="goSubmit()" class="btn btn-danger" style="background-color: #f97d66; width: 200px; border: 0; color: white; text-align: center;" value="게시된 사진보기">
                     	<input th:hidden="${loc.boardidx}" th:value="${loc.boardidx}" id="imgIdx">
                     </td>
                  </tr>
                  <tr>
                     <td align="center" colspan="2"><input type="button"
                        class="btn btn-danger"
                        id="apply" style="background-color: #f97d66; width: 200px; border: 0; color: white; text-align: center;"
                        value="참여"> <input type="submit" class="btn btn-danger"
                        style="background-color: #f97d66; width: 200px; border: 0; color: white; text-align: center;"
                        value="게시글 수정"> <input type="button" onclick="del()"
                        class="btn btn-danger"
                        style="background-color: #f97d66; width: 200px; border: 0; color: white; text-align: center;"
                        value="게시글 삭제"></td>
                  </tr>
               </table>
            </form>
         </div>
         
            <input th:value="${mapinfo.location}" name="location" th:hidden="${mapinfo.location}" id="location">
 </div>
     <input th:hidden="${session['user'].userPhone}" th:value="${session['user'].userPhone}" id="phone"/>
     <div th:if="loc.userId.value != null">
     <input th:hidden="${session['user'].userId}" th:value="${session['user'].userId}" id="userId" name="userId"/>
     <input th:hidden="${loc.userId}" th:value="${loc.userId}"  id="loc_userId" >
     <input th:hidden="${loc.userPhone}" th:value="${loc.userPhone}" id="loc_userPhone">
    </div>
   </div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
   <script>
   //새창띄우기
   function goSubmit(){
	   var imgIdx = document.getElementById("imgIdx").value;
         	window.open('/show/'+imgIdx,'about:blank', 'status=no, height=1000, width=700,scrollbars=yes, left='+ 600 + ', top='+ 130 + ', screenX='+ 600 + ', screenY= '+ 130);
         }
   
    function del(){
      var idx=document.getElementById("boardidx").value;
	  var loc_userPhone = document.getElementById("loc_userPhone").value //host 전화번호
 	  var phone = document.getElementById("phone").value; //get 전화번호
	  
      window.location.href="/deleteLocation?boardidx="+idx+"&loc_userPhone="+loc_userPhone+"&phone="+phone;
   } 


    $('#apply').click(function(){
		//참여확인
      var userId = document.getElementById("userId").value; // 현재 로그인 유저
      var loc_userId = document.getElementById("loc_userId").value; //기존 작성자
      var likeup2 = document.getElementById("likeup").value; // 참여자 수
      var wantWho = document.getElementById("wantWho").value; // 파티멤버 수
      var idx=document.getElementById("boardidx").value;// boardidx
     var likeup = Number(likeup2)+1;
      var ary = loc_userId.split(",");
      
      var ary2=false;
      if(wantWho == likeup2){   //남은 자리 확인
         alert("남은 자리가 없네요, 다음 기회에!!");
         return false;
      }else{
      for(var i in ary){
    	  if(userId == ary[i]){
    		  ary2 = false;
    		  break;
    	  }else{
    		  ary2 = true;
	    	  }
      }
         if(ary2 == false){
            alert("이미 참석하셨습니다!!");
            return false;
         }else if(ary2 == true){
            alert("약속 시간을 잘 지킵시다!! 문자로 정보를 전송해 드립니다.")
            window.location.href="/updateApply?userId="+userId+"&likeup="+likeup+"&loc_userId="+loc_userId+"&boardidx="+idx;
         }
      }
      
		var loc_userPhone = document.getElementById("loc_userPhone").value //host 전화번호
 		var location = document.getElementById("location").value;
 		var restaurant = document.getElementById("restaurant").innerHTML;//식당이름
 		var foodType = document.getElementById("foodType").innerHTML;//음식종류
 		var date  = document.getElementById("date").innerHTML;//날짜
 		var time  = document.getElementById("time").innerHTML;//시간
 		var phone = document.getElementById("phone").value;
 		alert("게시글의 정보가 보내집니다.");
 		 $.ajax({
 			type:"get",
 			url :"sendSMS2",
 			data:{
 				"phoneNumber" : phone,
 				"restaurant" : restaurant,
 				"foodType" : foodType,
 				"date" : date,
 				"time" : time,
 				"location" : location,
 				"loc_userPhone" : loc_userPhone
 			},
 			success:function(res){
 				alert("정상적으로 보내졌습니다.")
 				location.history(-1);
 			}
 		}) 
 	});
</script>
</body>
</html>